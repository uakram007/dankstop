{%- comment -%}
  The code below relies on the advanced-tag-loop snippet.
  The snippet is already included in snippets/breadrumbs.liquid
  because it is needed there too, but if you remove
  breadcrumbs you need to include this:

  {% include 'advanced-tag-loop' %}
{%- endcomment -%}
{%- comment -%}
{% assign collection_handle = collection.handle %}
{% capture remove_filters_settings_string %}{{ collection_handle }}_filters_to_remove{% endcapture %}
{% assign cats_to_remove = settings[remove_filters_settings_string] %}
{%- paginate collection.products by 50 %}
{%- endpaginate -%}
{%- endcomment -%}
{%- include 'advanced-tag-loop' -%}
{%- assign cats_to_remove = collection.metafields.collection_page.filters_to_remove -%}
{%- assign cats_to_remove_array = cats_to_remove | split: ', ' -%}
{%- assign cat_array_string = cat_array | join: ', ' | prepend: 'X-X, ' -%}
{%- assign cats_to_remove_check = cats_to_remove | strip -%}
{%- unless cats_to_remove_check == blank -%}
  {%- for cat_to_remove in cats_to_remove_array -%}
    {%- capture cat_to_remove_string -%}, {{ cat_to_remove }}{%- endcapture -%}
    {%- if forloop.first -%}
      {%- assign cat_array_string_filtered = cat_array_string | replace: cat_to_remove_string, ', X-X' -%}
    {%- else -%}
      {%- assign cat_array_string_filtered = cat_array_string_filtered | replace: cat_to_remove_string, ', X-X' -%}
    {%- endif -%}
  {%- endfor -%}
  {%- assign cat_array = cat_array_string_filtered | replace: 'X-X, ', '' | replace: 'X-X', '' | split: ', ' -%}
{%- endunless -%}
  
<div class="sidebar-inner">

  {%- comment -%}
  <button id="closeFiltersBtn" class="modal-close-btn filters-close-btn" aria-label="close">
    {%- include 'site--svgs' with 'closeBtnX', use_existing:true -%}
  </button>
  {%- endcomment -%}
  
  {%- if collection.all_tags.size > 0 -%}
  <h2 class="sidebar-header">{{ 'collections.sidebar.filters' | t }}</h2>
  {%- comment -%}
  {%- include 'collection--views' -%}
  {%- endcomment -%}
  {%- comment -%}
  Sold out / Out of stock Availability 
  {%- endcomment -%}
  {%- comment -%}
  <div class="sidebar-section">
    <input class="ss--state hidden" checked id="f-state--sos" type="checkbox"/>
    <label class="ss--btn" for="f-state--sos" title="{{ 'collections.sidebar.availability_title' | t }}">
      <h3>{{ 'collections.sidebar.availability_title' | t | downcase }}</h3>
    </label>
    <div class="sold-out-switch ss--inner">
      <label for="soldOutSwitch" class="sos--label">
        <input type="checkbox" id="soldOutSwitch" name="soldOutSwitch" class="sos--input"/>
        <span class="sos--text">{{ 'collections.sidebar.availability_switch_text' | t }}</span>
      </label>
    </div>
  </div>
  {%- endcomment %}


  
    <div class="sidebar-filter" data-has-collapse>
        {% if settings.category_layout == "right_sidebar" or settings.category_layout == "express_order" or template.suffix == 'express-order' or settings.category_layout == "mansory" or template.suffix == 'mansory' or settings.category_layout == "full_with" or template.suffix == 'fullwidth' or template.suffix == 'right-sidebar' or settings.category_layout == "with_banner" or template.suffix == 'with-banner' %}
        <a href="javascript:void(0)" title="{{ 'cart.general.close_cart' | t }}" class="close-sidebar close">
            {% include 'icon-close' %}    
        </a>
        {% endif %}
        
        <div class="refined-widgets"{% if has_refined == false %} style="display:none"{% endif %}>
            <div class="widget-title">
                <h3 class="sidebar-title">
                    <span {% if settings.enable_multilang %}data-translate="collections.sidebar.refined_by"{% endif %}>
                        {{ 'collections.sidebar.refined_by' | t }}           
                    </span>

                  {%- comment -%}
                  <a href="javascript:void(0)" class="clear-all text-hover" {% if has_refined == false %}style="display:none"{% endif %} {% if settings.enable_multilang %}data-translate="collections.sidebar.clear_all"{% endif %}>
                    {{ 'collections.sidebar.clear_all' | t }}
                  </a>
                  {%- endcomment -%}
                  <a href="{{ collection.url }}" class="clear-all text-hover" {% if has_refined == false %}style="display:none"{% endif %} {% if settings.enable_multilang %}data-translate="collections.sidebar.clear_all"{% endif %}>
                    {{ 'collections.sidebar.clear_all' | t }}
                  </a>
                   
                </h3>
            </div>

            <div class="widget-content">
                <ul class="refined">    
                    {%- for t in current_tags -%}
                    {%- assign tag = t | strip -%}
                    {%- assign tag_value = tag | handleize -%}
                  {%- assign tag_text = tag | replace: "_", ": " | capitalize | append: "<span>&nbsp;X</span>" -%}
                    <li>
                        <input type="checkbox" value="{{ tag_value }}" {% if current_tags contains tag %}checked{% endif %}/>
                      {%- comment -%}
                        <a href="{{tag_value}}" class="selected-tag">
                            {{ tag | replace: "_", ": " | capitalize }}<span>&nbsp;X</span>
                        </a>
                      {%- endcomment -%}
                      {{- tag_text | link_to_remove_tag: tag | replace: "?view=sidebar-filter", "" -}}
                    </li>
                    {%- endfor -%}
                </ul>
            </div>                  
        </div>
        
        {% for block in section.blocks %}  

        {% if block.type == 'filter_color' %}
        {% if block.settings.enable %}
        <div class="widget sidebar-tags filter-color">
            {% if block.settings.title != blank %}
            <div class="widget-title">
                <h3 class="sidebar-title">
                    {% include 'multilang' with block.settings.title %}

                    <a href="javascript:void(0)" class="clear text-hover" style="display:none" {% if settings.enable_multilang %}data-translate="collections.sidebar.clear"{% endif %}>
                    {{ 'collections.sidebar.clear' | t }}
                    </a>
                </h3>
            </div>
            {% endif %}

            <div class="widget-content">
                <ul class="list-tags">
                    {% for i in (1..20) %}
                    {% capture color_text %}color_text_{{ i }}{% endcapture %}
                    {% capture color %}color_img_{{ i }}{% endcapture %}

                    {% if block.settings[color] != blank %}
                    {%- assign img_url = block.settings[color] | img_url: '30x30' -%}
                    {% else %}
                    {%- assign img_url = '' -%}
                    {% endif %}

                    {% if color_text != blank %}
                    {% assign tag = block.settings[color_text] | strip %}
                    {% if collection.tags contains tag %} 
                    <li>
                        {% assign tag_value = tag | handleize %}
                        <input type="checkbox" value="{{ tag_value }}" {% if current_tags contains tag %}checked{% endif %}/>

                        <a href="javascript:void(0)" {% if current_tags contains tag %}class="active"{% endif %} title="{{tag}}">
                            <img src="{{ img_url }}" alt="">
                        </a>
                    </li>
                    {% endif %}
                    {% endif %}      
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
        {% endif %}

        {% if block.type == 'filter_text' %}
        {% if block.settings.enable %}
        <div class="widget sidebar-tags{% if block.settings.title == 'Size | Größe' %} filter-size{% endif %}">
            {% assign tags = block.settings.list_tags | split: ',' %}

            {% if block.settings.title != blank %}
            <div class="widget-title">
                <h3 class="sidebar-title">
                    {% include 'multilang' with block.settings.title %}

                    <a href="javascript:void(0)" class="clear text-hover" style="display:none" {% if settings.enable_multilang %}data-translate="collections.sidebar.clear"{% endif %}>
                    {{ 'collections.sidebar.clear' | t }}
                    </a>
                </h3>
            </div>
            {% endif %}

            <div class="widget-content">
                <ul class="list-tags">
                    {% for t in tags %}
                    {% assign tag = t | strip %}
                    {% assign tag_value = tag | handleize %} 

                    {% if current_tags contains tag %}
                    <li>
                        {% if settings.enable_multilang and tag_value contains '|' %}
                        <input type="checkbox" class="lang1" value="{{ tag_value | split: '|' | first }}" checked/>
                        <label class="lang1">
                            {{ tag | split: '|' | first }}
                        </label>

                        <input type="checkbox" class="lang2" value="{{ tag_value | split: '|' | last }}" checked/>
                        <label class="lang2">
                            {{ tag | split: '|' | last }}
                        </label>

                        {% else %}
                        <input type="checkbox" value="{{ tag_value | split: '|' | first }}" checked/>
                        <label>
                            {{ tag | split: '|' | first }}
                        </label>
                        {% endif %}
                    </li>
                    {% else %}

                    {% if collection.tags contains tag %} 
                    <li>
                        {% if settings.enable_multilang and tag_value contains '|' %}
                        <input type="checkbox" class="lang1" value="{{ tag_value | split: '|' | first }}"/>
                        <label class="lang1">
                            {{ tag | split: '|' | first }}
                        </label>

                        <input type="checkbox" class="lang2" value="{{ tag_value | split: '|' | last }}"/>
                        <label class="lang2">
                            {{ tag | split: '|' | last }}
                        </label>

                        {% else %}
                        <input type="checkbox" value="{{ tag_value | split: '|' | first }}"/>
                        <label>
                            {{ tag | split: '|' | first }}
                        </label>
                        {% endif %}
                    </li>
                    {% endif %}
                    {% endif %}
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
        {% endif %}
        {% endfor %} 
    </div>
      
  
  
  {%- comment %}
  Loop through tag categories
      {%- capture color_class -%}{{ cat }}-{{ color | handle | replace: '-', '_' }}{%- endcapture -%}
  {%- endcomment %}


  


  {%- capture span_wrapper_open -%}"><span>{%- endcapture -%}
  {%- capture span_wrapper_close -%}</span></a>{%- endcapture -%}

  {% assign filter_came = '' %}
  {%- for cat_item in cat_array -%}
    <span style="display: none;">{{cat_item}} , {{ filter_came}}</span>
    {%  assign cat_lower = cat_item |  downcase  %}
    {% if filter_came contains cat_lower %}

    {% else %}

    
      {%- if cat_item == 'color' -%}
      <div class="sidebar-section">
        <input class="ss--state hidden" id="f-state--{{ cat_item | handle }}" type="checkbox"/>
        <label class="ss--btn" for="f-state--{{ cat_item | handle }}" title="{{ cat_item }}">
          <h3 class="sidebar-title">{{ cat_item }}</h3>
        </label>
        <ul class="ss--inner advanced-filters color-filters grid-uniform">
          {%- for tag in collection.all_tags -%}
          {%- assign cat = tag | split: '_' | first -%}   
          {%- assign color = tag | split: '_' | last | downcase -%}   
          {%- capture color_under -%}{{ color | handle | replace: '-', '_' }}{%- endcapture -%}
          {%- assign color_filename = 'swatch_texture_' | append: color_under | append: '.jpg' -%}
          {%- assign color_url = color_filename | asset_url -%}
          {%- capture color_class_string -%}class="swatch-bg {{ cat }}-{{ color_under }} lazyload" data-expand="-1" data-bg="{{ color_url }}" data-color="{{ color }}" title="{%- endcapture -%}
          {%- if cat != tag and cat_item == cat -%}
          {%- capture tag_processed %}'{{ cat }}_{{ color }}'{%- endcapture -%}
          {%- if current_tags contains tag -%}
          <li class="a-filter active-filter grid-item one-fifth col-3" data-handle="{{ tag | handle }}" data-group="{{ cat_item }}">
            {{- tag | remove_first: cat_item | remove_first: '_' | link_to_remove_tag: tag | replace: 'title="Narrow selection to products matching tag color_', color_class_string | replace: "?view=sidebar-filter", "" | replace: "&amp;", "&" -}}
          </li>
          {%- else -%}
          <li class="a-filter filterHere" data-handle="{{ tag | handle }}" data-group="{{ cat_item }}">
            <div class="new_filter" data-filter-url="{{ collection.url}}/{{ tag | remove_first: cat_item | remove_first: '_' |  handle }}" style="cursor: pointer;font-size: 12px;" data-tags="
            {%- assign rmtag =  tag | remove_first: cat_item | remove_first: '_' |  handle  -%}
            {%- if all_tags contains rmtag -%}
              {{ all_tags }}
            {%- else -%}
              {%- if current_tags.size > 0 -%}
              {{- tag | remove_first: cat_item | remove_first: '_' |  handle -}}+{{- all_tags -}}
              {%- else -%}
                {{- tag | remove_first: cat_item | remove_first: '_' |  handle -}}  
              {%- endif -%}
            {%- endif -%} ">
              {{ tag | remove_first: cat_item | remove_first: '_' |  capitalize }}
            </div>
            {% comment %} {{- tag | remove_first: cat_item | remove_first: '_' | link_to_add_tag: tag | replace: '">', span_wrapper_open  | replace: '</a>', span_wrapper_close | replace: "?view=sidebar-filter", "" -}} {% endcomment %}
          </li> 
          {%- endif -%}
          {%- endif -%}
          {%- endfor -%}
        </ul>
      </div>
      {%- elsif cat_item == 'brand' or cat_item == 'type' -%}
      <div class="sidebar-section">
        <input class="ss--state hidden" checked id="f-state--{{ cat_item | handle }}" type="checkbox"/>
        <label class="ss--btn" for="f-state--{{ cat_item | handle }}" title="{{ cat_item }}">
          <h3 class="sidebar-title">{{ cat_item }}</h3>
        </label>
        <ul class="ss--inner advanced-filters">
          {%- comment -%}
          Loop through collection tags
          {%- endcomment -%}


          

          {%- assign filters_count = 0 -%}
          {%- assign show_more_filters_link_added = false -%}
          {%- for tag in collection.all_tags -%}
          {%- assign cat = tag | split: '_' | first -%}   
          {%- assign value = tag | split: '_' | last -%}   
          {%- if cat != tag and cat_item == cat -%}
          {%- comment -%}
          Strip out tag category prefix and add/remove link for tag filtering
          {%- endcomment -%}
          {%- assign filters_count = filters_count | plus: 1 -%}
          {%- capture tag_processed -%}'{{ cat }}_{{ value }}'{%- endcapture -%}

          
          {% assign all_tags = '' %} 
          {% if current_tags.size > 0 %}
            {% for tt in current_tags %}
              {%- assign value_tag = tt | split: '_' | last | handle -%}  
              {% assign all_tags = all_tags |  append: value_tag %}
              {% unless forloop.last %}
                {% assign all_tags = all_tags | append: '+' %}
              {% endunless %}
            {% endfor %}
          {% endif %} 
          

          {%- if current_tags contains tag -%}
          <li class="a-filter active-filter" data-handle="{{ tag | handle }}" data-group="{{ cat_item }}">
            {{- tag | remove_first: cat_item | remove_first: '_' | link_to_remove_tag: tag | replace: '">', span_wrapper_open  | replace: '</a>', span_wrapper_close | replace: "?view=sidebar-filter", "" -}}
          </li>
          {%- else -%}
          <li class="a-filter filterHere{% if filters_count > 5 %} past-fifth hidden-filter{% endif %}" data-handle="{{ tag | handle }}" data-group="{{ cat_item }}">
            <div class="new_filter" data-filter-url="{{ collection.url}}/{{ tag | remove_first: cat_item | remove_first: '_' |  handle }}" style="cursor: pointer;" data-tags="
            {%- assign rmtag =  tag | remove_first: cat_item | remove_first: '_' |  handle  -%}
            {%- if all_tags contains rmtag -%}
              {{ all_tags }}
            {%- else -%}
              {%- if current_tags.size > 0 -%}
              {{- tag | remove_first: cat_item | remove_first: '_' |  handle -}}+{{- all_tags -}}
              {%- else -%}
                {{- tag | remove_first: cat_item | remove_first: '_' |  handle -}}  
              {%- endif -%}
            {%- endif -%} ">
              {{ tag | remove_first: cat_item | remove_first: '_' |  capitalize }}
            </div>
            {% comment %} {{- tag | remove_first: cat_item | remove_first: '_' | link_to_add_tag: tag | replace: '">', span_wrapper_open  | replace: '</a>', span_wrapper_close | replace: "?view=sidebar-filter", "" -}} {% endcomment %}
          </li>
          {%- endif -%}
          {%- endif -%}
          {%- endfor -%}
          {%- if filters_count > 5 and show_more_filters_link_added == false -%}
          <li class="more-filters">
            <a class="more-f" href="#">{{ 'collections.sidebar.show_more' | t | append: " " | append: cat_item | append: "s" }}</a>
            <a class="less-f hidden-filter" href="#">{{ 'collections.sidebar.show_less' | t | append: " " | append: cat_item | append: "s" }}</a>
          </li>
          {%- assign show_more_filters_link_added = true -%}
          {%- endif -%}
        </ul>
      </div>
      {%- else -%}
      <div class="sidebar-section">
        <input class="ss--state hidden" id="f-state--{{ cat_item | handle }}" type="checkbox"/>
        <label class="ss--btn" for="f-state--{{ cat_item | handle }}" title="{{ cat_item }}">
          <h3 class="sidebar-title">{{ cat_item }}</h3>
        </label>
        <ul class="ss--inner advanced-filters">
          {%- comment -%}
          Loop through collection tags
          {%- endcomment -%}
          {%- for tag in collection.all_tags -%}
          {%- assign cat = tag | split: '_' | first -%}   
          {%- assign value = tag | split: '_' | last -%}   
          {%- if cat != tag and cat_item == cat -%}
          {%- comment -%}
          Strip out tag category prefix and add/remove link for tag filtering
          {%- endcomment -%}
          {%- capture tag_processed -%}'{{ cat }}_{{ value }}'{%- endcapture -%}
          {%- if current_tags contains tag -%}
          <li class="a-filter active-filter" data-handle="{{ tag | handle }}" data-group="{{ cat_item }}">
            {{- tag | remove_first: cat_item | remove_first: '_' | link_to_remove_tag: tag | replace: '">', span_wrapper_open  | replace: '</a>', span_wrapper_close | replace: "?view=sidebar-filter", "" -}}
          </li>
          {%- else -%}
          <li class="a-filter filterHere" data-handle="{{ tag | handle }}" data-group="{{ cat_item }}">
            <div class="new_filter" data-filter-url="{{ collection.url}}/{{ tag | remove_first: cat_item | remove_first: '_' |  handle }}" style="cursor: pointer;font-size: 12px;" data-tags="
            {%- assign rmtag =  tag | remove_first: cat_item | remove_first: '_' |  handle  -%}
            {%- if all_tags contains rmtag -%}
              {{ all_tags }}
            {%- else -%}
              {%- if current_tags.size > 0 -%}
              {{- tag | remove_first: cat_item | remove_first: '_' |  handle -}}+{{- all_tags -}}
              {%- else -%}
                {{- tag | remove_first: cat_item | remove_first: '_' |  handle -}}  
              {%- endif -%}
            {%- endif -%} ">
              {{ tag | remove_first: cat_item | remove_first: '_' |  capitalize }}
            </div>
            {% comment %} {{- tag | remove_first: cat_item | remove_first: '_' | link_to_add_tag: tag | replace: '">', span_wrapper_open  | replace: '</a>', span_wrapper_close | replace: "?view=sidebar-filter", "" -}} {% endcomment %}
          </li>
          
          {%- endif -%}
          {%- endif -%}
          {%- endfor -%}
        </ul>
      </div>
      {%- endif -%}

      
      {%- assign filter_came = filter_came | append: cat_lower | append: ',' -%}
    {% endif %}
  {%- endfor -%}
  {%- endif -%}
  </div>

 
  <script>
     
      
    document.querySelectorAll('.new_filter').forEach(function(el) {
      el.addEventListener('click', function() {         
          document.getElementById('filter_url').setAttribute('href','{{collection.url}}/'+el.getAttribute('data-tags'))
          document.getElementById('filter_url').click(); 
        
      })
    });
  </script>